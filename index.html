<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="lib/SlickGrid/slick.grid.css" type="text/css" />
    <link rel="stylesheet" href="lib/SlickGrid/css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css" />
    <link rel="stylesheet" href="sparql-table-viewer.css" type="text/css" />
</head>
<body>
    <form>
        <textarea id="query" style="width:90%;height:130px;padding:0;font-family:monospace">
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX u28: <http://environment.data.admin.ch/ubd/28/>

SELECT ?station ?pollutant ?aggregation ?year  ?measurement ?unit WHERE {
    ?m a <http://example.org/Measurement> .
    ?m <http://example.org/measurement> ?measurement.
    
    ?m <http://example.org/aggregation> ?a.
    ?a  rdfs:label ?aggregation.
    FILTER (lang(?aggregation) = 'de')

    ?m <http://example.org/station> ?s.
    ?s rdfs:label ?station.

    ?m <http://example.org/unit> ?u.
    ?u rdfs:label ?unit.
    FILTER (lang(?unit) = 'de')

    ?m <http://example.org/pollutant> ?p.
    ?p rdfs:label ?pollutant.
    FILTER (lang(?pollutant) = 'de')

    ?m <http://example.org/year> ?y
    BIND(SUBSTR(xsd:string(?y),46) AS ?year)
}
        </textarea>
        <br />
        <input id="run-query" type="button" value="run sparql" />

        <br /><br />
    </form>
    <div id="myGrid" style="width:90%;height:490px;">

        <div><label>test</label></div>
    </div>
    </table>

    <script type="text/javascript" src="lib/SlickGrid/lib/jquery-1.7.min.js"></script>
    <script type="text/javascript" src="lib/SlickGrid/lib/jquery.event.drag-2.2.js"></script>
    <script type="text/javascript" src="lib/SlickGrid/lib/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="lib/SlickGrid/slick.core.js"></script>
    <script type="text/javascript" src="lib/SlickGrid/slick.grid.js"></script>
    <script type="text/javascript" src="js/data-loader.js"></script>
    <script type="text/javascript">
	// demo js
        var grid;
        var loader;
        var columns = [];
        var PAGESIZE = 50;
        var columnWidth = 350;
        var options = {
            enableCellNavigation: false,
            enableColumnReorder: true,
            syncColumnCellResize: true,
            enableAddRow: true,
            asyncEditorLoading: true,
            forceFitColumns: true,
            topPanelHeight: 25,
            rowHeight: 24
        };
        var loadingIndicator;

        loader = new udb.DataLoader(65779, PAGESIZE);

        $(function () {


            function initGridAndLoader() {
                columns = [];

                grid = new Slick.Grid("#myGrid", loader.data, [], options);

                loader.onDataLoading.subscribe(function (e, args) {
                    if (!loadingIndicator) {
                        var g = $("#myGrid");
                        loadingIndicator = $("<div class='loading-indicator'><label>loading</label></div>").appendTo(g);
                    }

                    loadingIndicator.show();
                });


                loader.onDataLoaded.subscribe(function (e, args) {
                    console.log(args);
                    for (var i = args.from; i <= args.to; i++) {
                        grid.invalidateRow(i); // causes the appropriate rows to redraw.
                    }
                    grid.updateRowCount(); // uses data.length
                    grid.render();

                    loadingIndicator.fadeOut();
                });

                loader.onPageLoading.subscribe(function (e, args) {
                    console.log("Page loading: " + args.from + " to " + args.to);
                });


                var viewportChangedTimer;


                grid.onViewportChanged.subscribe(function (e, args) {
                    console.log('viewport changed');
                    clearTimeout(viewportChangedTimer);
                    // only fire this every 1/4 sec at most.
                    viewportChangedTimer = setTimeout(function () {
                        var vp = grid.getViewport();
                        loader.ensureData(vp.top, vp.bottom);
                    }, 250);
                });

                grid.onSort.subscribe(function (e, args) {
                    loader.setSort(args.sortCol.field, args.sortAsc);
                    var vp = grid.getViewport();
                    loader.clear();
                    loader.ensureData(vp.top, vp.bottom);

                    console.log("sort called");
                });

                loader.onColumnsChanged.subscribe(function (e, columns) {
                    grid.setColumns(columns);
                    console.log("set columns to: " + columns);
                });

            }

            initGridAndLoader();
            $("#run-query").click(function (e) {
                loader.setQuery($("#query").val());
                initGridAndLoader();
                loader.clear();
                var vp = grid.getViewport();
                loader.ensureData(vp.top, vp.bottom);
            });
        });
    </script>
	
    
</body>
</html>
